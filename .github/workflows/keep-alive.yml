name: ðŸš€ Keep Supabase Alive

on:
  # SCHEDULE - Runs every 6 hours
  schedule:
    # At :00 minutes of every 6th hour (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */12 * * *'
  
  # MANUAL - Click "Run workflow" button
  workflow_dispatch:
  
  # AUTO - Runs when code is pushed (any branch)
  push:
  
  # AUTO - Runs on pull requests (any branch)
  pull_request:

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      # STEP 1: Show info
      - name: ðŸ“Š Show Execution Info
        run: |
          echo "========================================"
          echo "ðŸ Supabase Keep-Alive Started"
          echo "ðŸ• UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸŽ¯ Trigger: ${{ github.event_name }}"
          echo "ðŸ‘¤ Actor: ${{ github.actor }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref }}"
          echo "ðŸ”§ Workflow: ${{ github.workflow }}"
          echo "========================================"
      
      # STEP 2: Ping Supabase with retry
      - name: ðŸ“¡ Ping Supabase API
        run: |
          echo "Target: ${{ secrets.SUPABASE_URL }}/rest/v1/"
          
          MAX_RETRIES=3
          RETRY_DELAY=5
          SUCCESS=false
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."
            
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
              -H "Accept: application/json" \
              -m 15 \
              "${{ secrets.SUPABASE_URL }}/rest/v1/" || echo "CURL_ERROR")
            
            echo "HTTP Status: $STATUS"
            
            # Any 2xx or 3xx response is success
            if [[ "$STATUS" =~ ^2[0-9][0-9]$ ]] || [[ "$STATUS" =~ ^3[0-9][0-9]$ ]]; then
              echo "âœ… SUCCESS! Supabase responded normally."
              SUCCESS=true
              break
            fi
            
            # Even 401/403 means endpoint exists (counts as activity!)
            if [[ "$STATUS" =~ ^4[0-9][0-9]$ ]]; then
              echo "âš ï¸ Authentication needed, but endpoint EXISTS (this counts as activity!)"
              SUCCESS=true
              break
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "â³ Waiting $RETRY_DELAY seconds before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ All attempts failed"
            exit 1
          fi
      
      # STEP 3: Log success
      - name: ðŸ“ Log Completion
        if: success()
        run: |
          echo "========================================"
          echo "âœ… Supabase Keep-Alive Completed"
          echo "ðŸ• Finished at: $(date -u '+%H:%M:%S UTC')"
          echo "ðŸ“… Next run: In 6 hours"
          echo "========================================"
          
          # Create simple log file
          cat > summary.txt << EOF
          Supabase Keep-Alive Summary
          ===========================
          Time: $(date -u)
          Event: ${{ github.event_name }}
          Branch: ${{ github.ref }}
          Status: SUCCESS
          Project: ${{ secrets.SUPABASE_URL }}
          
          Your Supabase project will remain active! âœ…
          EOF
      
